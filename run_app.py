#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ููู ุชุดุบูู ูุญุณู ููุชุทุจูู ูุน ูุธุงู ูุฑุงูุจุฉ ุงูุชุบููุฑุงุช ุงูุชููุงุฆู
"""

import os
import sys
import subprocess
import signal
import time
from pathlib import Path

def install_requirements():
    """ุชุซุจูุช ุงููุชุทูุจุงุช ุชููุงุฆูุงู"""
    try:
        subprocess.check_call([sys.executable, "-m", "pip", "install", "-r", "requirements.txt"])
        print("โ ุชู ุชุซุจูุช ุฌููุน ุงููุชุทูุจุงุช ุจูุฌุงุญ")
    except subprocess.CalledProcessError as e:
        print(f"โ ุฎุทุฃ ูู ุชุซุจูุช ุงููุชุทูุจุงุช: {e}")
        sys.exit(1)

def check_and_create_directories():
    """ุฅูุดุงุก ุงููุฌูุฏุงุช ุงููุทููุจุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ"""
    directories = ["data", "storage", "exports", "static"]
    for directory in directories:
        Path(directory).mkdir(exist_ok=True)
    print("โ ุชู ุงูุชุญูู ูู ุงููุฌูุฏุงุช ุงููุทููุจุฉ")

def run_streamlit():
    """ุชุดุบูู ุชุทุจูู Streamlit"""
    try:
        # ุฅุนุฏุงุฏ ูุชุบูุฑุงุช ุงูุจูุฆุฉ ูุชุญุณูู ุงูุฃุฏุงุก
        os.environ["STREAMLIT_SERVER_HEADLESS"] = "true"
        os.environ["STREAMLIT_SERVER_ENABLE_CORS"] = "false"
        os.environ["STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION"] = "false"
        
        # ุชุดุบูู ุงูุชุทุจูู
        cmd = [
            sys.executable, "-m", "streamlit", "run", 
            "waiting_list_contracts_app.py",
            "--server.port=8501",
            "--server.address=0.0.0.0",
            "--server.headless=true",
            "--server.fileWatcherType=auto",
            "--server.enableCORS=false",
            "--server.enableXsrfProtection=false"
        ]
        
        print("๐ ุจุฏุก ุชุดุบูู ุงูุชุทุจูู...")
        print("๐ฑ ููููู ุงููุตูู ููุชุทุจูู ุนูู: http://localhost:8501")
        print("โน๏ธ  ููุฅููุงู: ุงุถุบุท Ctrl+C")
        
        process = subprocess.Popen(cmd)
        
        def signal_handler(sig, frame):
            print("\n๐ ุฅููุงู ุงูุชุทุจูู...")
            process.terminate()
            sys.exit(0)
        
        signal.signal(signal.SIGINT, signal_handler)
        process.wait()
        
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ุชุดุบูู ุงูุชุทุจูู: {e}")
        sys.exit(1)

def main():
    """ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ"""
    print("=" * 60)
    print("๐ฅ ุงููุดุฑูุน ุงููููู ูููุงุฆู ุงูุงูุชุธุงุฑ - ูุธุงู ุงูุชุนุงูุฏ")
    print("=" * 60)
    
    # ุงูุชุญูู ูู ูุฌูุฏ ููู ุงูุชุทุจูู
    if not Path("waiting_list_contracts_app.py").exists():
        print("โ ููู ุงูุชุทุจูู ุบูุฑ ููุฌูุฏ!")
        sys.exit(1)
    
    # ุชุซุจูุช ุงููุชุทูุจุงุช
    if Path("requirements.txt").exists():
        print("๐ฆ ุชุซุจูุช ุงููุชุทูุจุงุช...")
        install_requirements()
    
    # ุฅูุดุงุก ุงููุฌูุฏุงุช
    check_and_create_directories()
    
    # ุชุดุบูู ุงูุชุทุจูู
    run_streamlit()

if __name__ == "__main__":
    main()