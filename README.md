# المشروع القومي لقوائم الانتظار - نظام التعاقد المحسن

## 🚀 التحسينات الجديدة

### ✨ المميزات المضافة:
- **نظام Migrations تلقائي**: يطبق التغييرات على قاعدة البيانات تلقائياً دون الحاجة لحذفها
- **مراقبة التغييرات**: يراقب التغييرات في قاعدة البيانات ويحدث النظام تلقائياً
- **تحديث البيانات الفوري**: عند تغيير الإعدادات، يتم تطبيقها على جميع الطلبات الموجودة
- **تحسين الأداء**: إضافة فهارس لتسريع الاستعلامات
- **مسح الذاكرة المؤقتة**: تحديث البيانات المعروضة فوراً بعد التغييرات

### 🔧 التحسينات التقنية:
- نظام migrations متدرج لتحديث قاعدة البيانات
- مراقب ملفات لتطبيق التغييرات تلقائياً
- تحسين استعلامات قاعدة البيانات
- إدارة أفضل للذاكرة المؤقتة

## 📋 المتطلبات

```bash
streamlit
pandas
openpyxl
plotly
streamlit-option-menu
pymysql
passlib[bcrypt]
watchdog  # جديد - لمراقبة التغييرات
```

## 🚀 طريقة التشغيل

### الطريقة الأولى (المحسنة):
```bash
python run_app.py
```

### الطريقة التقليدية:
```bash
# تثبيت المتطلبات
pip install -r requirements.txt

# تشغيل التطبيق
streamlit run waiting_list_contracts_app.py
```

## 🔄 كيف يعمل النظام المحسن

### 1. نظام Migrations:
- يتحقق من إصدار قاعدة البيانات الحالي
- يطبق التحديثات المطلوبة تدريجياً
- يحفظ إصدار قاعدة البيانات لتجنب التحديثات المكررة

### 2. مراقبة التغييرات:
- يراقب ملف قاعدة البيانات
- يطبق التحديثات عند اكتشاف تغييرات
- ينظف الذاكرة المؤقتة تلقائياً

### 3. التحديث التلقائي:
- عند تغيير إعدادات المستندات الاختيارية
- عند إضافة أنواع مستندات جديدة
- عند تعديل حالات الطلبات
- عند تحديث أنواع المستشفيات أو القطاعات

## 📊 تحسينات الأداء

### فهارس قاعدة البيانات:
- `idx_requests_hospital_service`: لتسريع البحث بالمستشفى والخدمة
- `idx_requests_status`: لتسريع البحث بالحالة
- `idx_requests_created_at`: لتسريع ترتيب التواريخ
- `idx_documents_request_id`: لتسريع جلب المستندات
- `idx_activity_log_timestamp`: لتسريع سجل النشاط

### إدارة الذاكرة:
- مسح تلقائي للذاكرة المؤقتة عند التحديثات
- تحديث فوري للبيانات المعروضة
- تجنب البيانات القديمة

## 🛠️ الاستخدام

### للمطورين:
1. أي تغيير في بنية قاعدة البيانات يتم إضافته في `run_migrations()`
2. زيادة `DB_SCHEMA_VERSION` عند إضافة migration جديد
3. النظام سيطبق التحديثات تلقائياً عند التشغيل

### للمستخدمين:
- لا حاجة لحذف قاعدة البيانات عند التحديث
- التغييرات تطبق تلقائياً على الطلبات الموجودة
- البيانات محفوظة ومحدثة باستمرار

## 🔒 الأمان

- تشفير محسن لكلمات المرور باستخدام bcrypt
- تحديث تلقائي لكلمات المرور القديمة
- حماية من هجمات التوقيت

## 📝 سجل التغييرات

### الإصدار 5.0:
- إضافة نظام migrations
- مراقبة التغييرات التلقائية
- تحسين الأداء والفهارس
- تحديث تلقائي للبيانات

### الإصدار 4.0:
- النظام الأساسي مع جميع المميزات

## 🆘 استكشاف الأخطاء

### مشكلة: البيانات لا تتحدث
**الحل**: النظام الجديد يحدث البيانات تلقائياً، انتظر ثوانٍ قليلة

### مشكلة: خطأ في قاعدة البيانات
**الحل**: النظام سيطبق migrations تلقائياً عند التشغيل

### مشكلة: بطء في الأداء
**الحل**: الفهارس الجديدة تحسن الأداء تلقائياً

## 📞 الدعم الفني

للمساعدة أو الإبلاغ عن مشاكل، يرجى التواصل مع فريق التطوير.

---
© 2025 المشروع القومي لقوائم الانتظار - نظام محسن ومطور